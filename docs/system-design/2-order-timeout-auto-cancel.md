---
sidebar: heading
---

# 订单30分钟未支付自动取消怎么实现？

## 数据库轮询

使用一个线程定时的去扫描数据库，通过订单时间来判断是否有超时的订单，然后进行取消操作。缺点是存在延迟，比如你每隔5分钟扫描一次，那最差的延迟时间就是5分钟。而且如果订单量很大的话，每隔几分钟这样扫描一次，对数据库性能消耗极大。

## JDK的延迟队列

利用JDK自带的DelayQueue来实现，这是一个无界阻塞队列，该队列只有在延时时间到了的时候才能从中获取元素。该方案缺点是服务器重启后，数据会全部消失。并且在下单未付款的订单数太多的情况下，很容易就出现OOM异常。

## Redis

使用Redis的Keyspace Notifications特性（Redis版本2.8以上）。该机制可以在key失效之后，提供一个回调，实际上是Redis会给客户端发送一个消息。生成订单的时候把订单号存入 Redis 作为 key，按订单有效时间设置失效时间，当监听到键失效的时候就可以执行代码将订单标记为过期。

## 使用消息队列

可以使用RabbitMQ模拟延时队列的功能。RabbitMQ具有以下两个特性，可以实现延迟队列。

- RabbitMQ可以针对Queue和Message设置 x-message-tt，来控制消息的生存时间，如果超时，则消息变为死信。

- RabbitMQ的Queue可以配置x-dead-letter-exchange 和x-dead-letter-routing-key两个参数，用来控制队列内出现了死信的时候，按照这两个参数重新路由。

基于以上两个特性，就可以模拟出延迟消息的功能。

此方案优点是高效，容易进行横向扩展，消息支持持久化，增加了可靠性。缺点是引入了RabbitMQ，所以复杂度和成本变高。



> 参考：https://blog.51cto.com/zhongmayisheng/4104804